name: Deploy Soul Gateway

on:
  push:
    branches: [main]
    paths:
      - 'proxies/soul-gateway/**'
      - 'proxies/soul-gateway-app/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy Soul Gateway
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "PGPASSWORD='${{ secrets.PGPASSWORD }}' DEFAULT_PROXY_API_KEY='${{ secrets.DEFAULT_PROXY_API_KEY }}' UPSTREAM_URL='${{ secrets.UPSTREAM_URL }}' bash -s" << 'DEPLOY_SCRIPT'
            set -e

            WORKSPACE="$HOME/soulGateway"
            PLOINKY="$(which ploinky 2>/dev/null || echo "$HOME/ploinky/bin/ploinky")"
            PROXIES_REPO="https://github.com/PloinkyRepos/proxies.git"
            BASIC_REPO="https://github.com/PloinkyRepos/Basic.git"
            CODE_DIR="$HOME/code"

            echo "=== Soul Gateway Deploy ==="

            # Clone or pull repos
            if [ -d "$CODE_DIR/proxies/.git" ]; then
              echo "Pulling latest proxies..."
              cd "$CODE_DIR/proxies" && git fetch origin main && git reset --hard origin/main
            else
              echo "Cloning proxies repo..."
              mkdir -p "$CODE_DIR"
              git clone "$PROXIES_REPO" "$CODE_DIR/proxies"
            fi

            if [ -d "$CODE_DIR/basic/.git" ]; then
              echo "Pulling latest basic..."
              cd "$CODE_DIR/basic" && git fetch origin main && git reset --hard origin/main
            else
              echo "Cloning basic repo..."
              git clone "$BASIC_REPO" "$CODE_DIR/basic"
            fi

            # Embed soul-gateway-app inside soul-gateway/app/
            # so the container finds it at /code/app/
            echo "Embedding soul-gateway-app..."
            rm -rf "$CODE_DIR/proxies/soul-gateway/app"
            cp -a "$CODE_DIR/proxies/soul-gateway-app" "$CODE_DIR/proxies/soul-gateway/app"

            # Create workspace
            mkdir -p "$WORKSPACE"
            cd "$WORKSPACE"

            # Register repos with ploinky
            mkdir -p "$WORKSPACE/.ploinky/repos"
            ln -sfn "$CODE_DIR/proxies" "$WORKSPACE/.ploinky/repos/proxies"
            ln -sfn "$CODE_DIR/basic" "$WORKSPACE/.ploinky/repos/basic"

            if [ ! -f "$WORKSPACE/.ploinky/enabled_repos.json" ]; then
              echo '["basic","proxies"]' > "$WORKSPACE/.ploinky/enabled_repos.json"
            fi

            # Configure env vars
            echo "Configuring env vars..."
            $PLOINKY var UPSTREAM_URL "$UPSTREAM_URL"
            $PLOINKY var PGHOST "host.containers.internal"
            $PLOINKY var PGPORT "5432"
            $PLOINKY var PGUSER "postgres"
            $PLOINKY var PGPASSWORD "$PGPASSWORD"
            $PLOINKY var PGDATABASE "postgres"
            $PLOINKY var DEFAULT_PROXY_API_KEY "$DEFAULT_PROXY_API_KEY"

            # Stop and clean existing
            if podman ps -a --format '{{.Names}}' 2>/dev/null | grep -q "soul-gateway.*soulGateway"; then
              echo "Stopping existing soul-gateway..."
              $PLOINKY stop soul-gateway 2>&1 || true
              $PLOINKY clean soul-gateway 2>&1 || true
            fi

            # Start soul-gateway (redirect to log so watchdog doesn't keep SSH open)
            mkdir -p "$WORKSPACE/logs"
            echo "Starting soul-gateway..."
            $PLOINKY start soul-gateway > "$WORKSPACE/logs/deploy.log" 2>&1

            # Health check
            echo "Waiting for startup..."
            for i in $(seq 1 30); do
              sleep 2
              if curl -sf http://localhost:8042/health > /dev/null 2>&1; then
                echo "Soul Gateway is healthy!"
                curl -s http://localhost:8042/health
                echo ""
                exit 0
              fi
              echo "  Attempt $i/30..."
            done

            echo "ERROR: Soul Gateway failed to start"
            echo "=== Deploy log ==="
            tail -30 "$WORKSPACE/logs/deploy.log" 2>/dev/null || true
            echo "=== Container log ==="
            podman logs --tail 30 "$(podman ps -a --format '{{.Names}}' | grep soul-gateway | head -1)" 2>&1 || true
            exit 1
          DEPLOY_SCRIPT

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
