
> file-parser-agent@0.1.0 test
> node --test tests/**/*.test.mjs

▶ process-documents (integration)
  ▶ normaliseInput and extractFileDescriptor
    ✔ should process simple file input (756.129521ms)
    ✔ should process input wrapped in "input" property (666.923662ms)
    ✔ should process input wrapped in "arguments" property (708.448007ms)
    ✔ should process input wrapped in "args" property (683.804896ms)
    ✔ should handle file with type hint (737.347116ms)
    ✔ should handle file with fileType property (741.129315ms)
    ✔ should fail when no file is provided (700.459423ms)
    ✔ should fail when file is empty string (710.316854ms)
    ✔ should fail when file is whitespace only (685.211026ms)
  ✔ normaliseInput and extractFileDescriptor (6391.610687ms)
  ▶ resolveOptions
    ✔ should use default options when none provided (674.79181ms)
    ✔ should handle maxPreviewChars option (711.69392ms)
    ✔ should handle tableSampleRows option (766.537877ms)
    ✔ should enforce minimum maxPreviewChars of 500 (730.706314ms)
    ✔ should enforce minimum tableSampleRows of 1 (752.226615ms)
  ✔ resolveOptions (3636.438616ms)
  ▶ emitWarnings
    ✔ should emit warnings for non-existent files to stderr (741.408476ms)
    ✔ should emit warnings for unsupported file types (759.473007ms)
  ✔ emitWarnings (1501.113957ms)
  ▶ full workflow
    ✔ should process text file end-to-end (748.274937ms)
    ✔ should process markdown file end-to-end (879.380129ms)
    ✔ should process XLSX file end-to-end (739.771935ms)
    ✔ should process empty text file (775.311046ms)
    ✔ should handle absolute paths (751.794835ms)
    ✔ should handle metadata with tool property (756.231171ms)
    ✔ should handle complex nested options (718.521088ms)
  ✔ full workflow (5369.816423ms)
  ▶ error handling
    ✔ should exit with code 1 on error (753.461468ms)
    ✔ should handle invalid JSON gracefully (705.68084ms)
    ✔ should handle empty stdin (652.309781ms)
  ✔ error handling (2111.754789ms)
✔ process-documents (integration) (19011.746449ms)
▶ document-loader
  ▶ loadDocuments
    ✔ should load a text file (19.673835ms)
    ✔ should load a markdown file as text (1.679295ms)
    ✔ should load an empty text file (1.366969ms)
    ✔ should load an XLSX file with tables (17.935144ms)
    ✔ should respect tableSampleRows option (5.035198ms)
    ✔ should handle XLSX with empty sheet (3.492587ms)
    ✔ should load multiple documents (4.483531ms)
    ✔ should accept file descriptors with path property (1.240214ms)
    ✔ should accept file descriptors with label (0.973722ms)
    ✔ should accept file descriptor with type hint (1.190534ms)
    ✔ should use type hint when extension is missing (2.468633ms)
    ✔ should warn about unsupported file types (1.967222ms)
    ✔ should warn about non-existent files but continue processing (1.471246ms)
    ✔ should throw error when no files can be loaded (0.772556ms)
    ✔ should throw error for empty file array (0.270049ms)
    ✔ should throw error for non-array input (0.176673ms)
    ✔ should resolve relative paths with workspaceRoot (1.330533ms)
    ✔ should use WORKSPACE_PATH env variable if workspaceRoot not provided (1.186969ms)
    ✔ should truncate preview text to previewLimit (1.134751ms)
    ✔ should calculate correct word count (0.858635ms)
    ✔ should generate different checksums for different files (1.127474ms)
    ✔ should warn about invalid descriptors (0.814346ms)
    ✔ should warn about descriptors with missing path (0.916827ms)
  ✔ loadDocuments (74.017502ms)
✔ document-loader (74.437489ms)
▶ llm-runner
  ▶ hasLlmAccess
    ✔ should return false when no API keys are set (4.993576ms)
    ✔ should return true when OPENAI_API_KEY is set (0.58246ms)
    ✔ should return true when ANTHROPIC_API_KEY is set (1.720511ms)
    ✔ should return true when GEMINI_API_KEY is set (1.754154ms)
    ✔ should return true when MISTRAL_API_KEY is set (1.351397ms)
    ✔ should return true when DEEPSEEK_API_KEY is set (1.733203ms)
    ✔ should return true when OPENROUTER_API_KEY is set (8.255153ms)
    ✔ should return true when LLM_API_KEY is set (0.320231ms)
    ✔ should return true when multiple API keys are set (0.414834ms)
  ✔ hasLlmAccess (23.793059ms)
  ▶ runStructuredExtraction
    ✔ should throw error when no documents provided (1.467414ms)
    ✔ should throw error when documents is not an array (0.476482ms)
    ✔ should throw error when no LLM credentials available (0.433464ms)
  ✔ runStructuredExtraction (3.205913ms)
  ▶ buildDocumentContext (integration)
    ✔ should build context from documents with text content (0.424376ms)
    ✔ should build context from documents with tables (0.208333ms)
  ✔ buildDocumentContext (integration) (1.629701ms)
✔ llm-runner (29.393156ms)
▶ markdown-formatter
  ▶ documentsToMarkdown
    ✔ should format a single text document (1.723897ms)
    ✔ should use label if provided (0.305993ms)
    ✔ should format PDF metadata with page count (0.278836ms)
    ✔ should format spreadsheet with tables (0.589573ms)
    ✔ should format empty spreadsheet sheet (0.463005ms)
    ✔ should escape pipe characters in table cells (0.312178ms)
    ✔ should handle null and undefined values in tables (0.614582ms)
    ✔ should format multiple documents with separator (0.386304ms)
    ✔ should throw error for empty documents array (1.311948ms)
    ✔ should throw error for non-array input (0.599472ms)
    ✔ should handle document with no text content (1.340295ms)
    ✔ should include Tables count in metadata when present (0.235804ms)
  ✔ documentsToMarkdown (11.816724ms)
✔ markdown-formatter (12.454748ms)
▶ path-utils
  ▶ resolveWorkspacePath
    ✔ should resolve absolute paths correctly (1.964415ms)
    ✔ should resolve relative paths based on cwd (0.278856ms)
    ✔ should resolve relative paths based on workspaceRoot when provided (0.372339ms)
    ✔ should prefer workspaceRoot over cwd (0.247739ms)
    ✔ should handle Windows-style backslashes (0.255919ms)
    ✔ should trim whitespace from path (0.216669ms)
    ✔ should throw error for empty path (1.031027ms)
    ✔ should throw error for non-string path (0.953719ms)
    ✔ should throw error for whitespace-only path (0.297117ms)
  ✔ resolveWorkspacePath (7.335906ms)
  ▶ assertFileReadable
    ✔ should not throw for readable file (25.630658ms)
    ✔ should throw error for non-existent file (1.851259ms)
    ✔ should throw error for directory (0.708849ms)
  ✔ assertFileReadable (28.989919ms)
  ▶ readFileStats
    ✔ should return file statistics (3.1289ms)
    ✔ should throw error for non-existent file (0.808984ms)
  ✔ readFileStats (4.166834ms)
  ▶ readText
    ✔ should read text file content (1.886397ms)
    ✔ should return empty string for empty file (1.184609ms)
    ✔ should handle UTF-8 encoding (0.966463ms)
  ✔ readText (4.385286ms)
  ▶ readBinary
    ✔ should read file as Buffer (3.275973ms)
    ✔ should return empty Buffer for empty file (0.981584ms)
    ✔ should read binary files (0.674132ms)
  ✔ readBinary (5.227641ms)
✔ path-utils (52.375213ms)
