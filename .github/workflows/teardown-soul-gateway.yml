name: Teardown Soul Gateway

on:
  workflow_dispatch:

jobs:
  teardown:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Teardown Soul Gateway
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash -s << 'TEARDOWN'
            set -e
            WORKSPACE="$HOME/soulGateway"
            PLOINKY="$(which ploinky 2>/dev/null || echo "$HOME/ploinky/bin/ploinky")"

            echo "=== Tearing down Soul Gateway ==="

            if [ -d "$WORKSPACE" ]; then
              cd "$WORKSPACE"
              echo "Stopping soul-gateway..."
              $PLOINKY stop soul-gateway 2>&1 || true
              echo "Cleaning containers..."
              $PLOINKY clean 2>&1 || true
              echo "Removing workspace..."
              rm -rf "$WORKSPACE"
              echo "Removing code repos..."
              rm -rf "$HOME/code/proxies" "$HOME/code/basic"
              echo "Soul Gateway torn down."
            else
              echo "No soulGateway workspace found, nothing to do."
            fi
          TEARDOWN

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
